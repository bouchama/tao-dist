{"version":3,"sources":["routes.js","migrate.js"],"names":["define","ResultServerMgt","actions","migrate","module","$","__","context","helpers","feedback","start","options","click","e","source","operation","this","attr","sources","targets","$source","$target","$migrationDialog","$migrationInfo","children","migrateDataUrl","root_url","empty","each","val","push","append","id","replace","html","parent","text","length","show","dialog","modal","width","height","buttons","hide","addClass","off","ajax","url","type","dataType","data","target","success","info","error","status","$ul","class","i","uri","testTakers","deliveries","callIds","prepend"],"mappings":"AAqBAA,OAAA,uCAAA,WACA,YAEA,QACAC,iBAEAC,SACAC,QAAA,0BCRAH,OAAA,sCAAA,SAAA,SAAA,OAAA,UAAA,UAAA,eACA,SAAAI,OAAAC,EAAAC,GAAAC,QAAAC,QAAAC,UAiIA,OA9HAC,MAAA,SAAAC,SACAN,EAAA,aAAAO,MAEA,SAAAC,GAEA,GAOAC,QAPAC,UAAAV,EAAAW,MAAAC,KAAA,MACAC,WACAC,WACAC,QAAAf,EAAA,cACAgB,QAAAhB,EAAA,cACAiB,iBAAAjB,EAAA,sBACAkB,eAAAD,iBAAAE,SAAA,kBAIAC,eAAAlB,QAAAmB,SAAA,6CAcA,OAXAN,SAAAO,QACAN,QAAAM;gBAEAtB,EAAA,2BAAAuB,KAAA,WACAd,OAAAT,EAAAW,MAAAa,MACAX,QAAAY,KAAAhB,QAEAM,QACAW,OAAA1B,EAAA,UAAA2B,GAAAlB,OAAAmB,QAAA,iBAAA,OACAC,KAAA7B,EAAAW,MAAAmB,SAAAC,WAEAlB,QAAAmB,QAKAhC,EAAA,2BAAAuB,KAAA,WACAT,QAAAW,KAAAzB,EAAAW,MAAAa,OAEAR,QAAAU,OAAA1B,EAAA,UAAA+B,KAAA/B,EAAAW,MAAAmB,SAAAC,WAEAjB,QAAAkB,QAKAhC,EAAA,iBAAA6B,KAAA,UAAAnB,UAAA,YAEAQ,eAAAC,WAAAc,WAEAhB,kBACAL,KAAA,QAAA,uBACAsB,QACAC,OAAA,EACAC,MAAA,IACAC,OAAA,IACAC,UAEAX,GAAA,iBACAI,KAAA9B,GAAA,UAEAM,MAAA,WACAP,EAAAW,MAAAuB,OAAA,YAIAP,GAAA;oBACAI,KAAA9B,GAAA,WACAM,MAAA,WACAW,eAAAqB,OACAtB,iBAAAE,SAAA,oBAAAoB,OACAtB,iBAAAE,SAAA,sBAAAc,OACAjC,EAAA,mBAAAwC,SAAA,YAAAC,IAAA,SAEAzC,EAAA0C,MACAC,IAAAvB,eACAwB,KAAA,OACAC,SAAA,OACAC,MACArC,OAAAI,QACAkC,OAAAjC,QACAJ,UAAAA,WAEAsC,QAAA,SAAAF,MAIA,GAFA7B,iBAAAE,SAAA,sBAAAoB,QAEAO,KAAAE,QAGA,MAFAC,MAAAhB,WACA7B,YAAA8C,MAAAJ,KAAAK,OAIAjC,gBAAAC,SAAA,oBAAAoB,MAEA,IACAZ,IADAyB,IAAApD,EAAA,SAAAqD,MAAA,iBAEArD,GAAAuB,KAAAuB,KAAAA,KAAA,SAAAQ,EAAA7C,QACAkB,GAAAlB,OAAA8C,IAAA3B,QAAA,iBAAA;4CACAwB,IAAA1B,OAAA1B,EAAA,UAAA+B,KAAAtB,OAAA+C,WAAAvD,GAAA,mBACAmD,IAAA1B,OAAA1B,EAAA,UAAA+B,KAAAtB,OAAAgD,WAAAxD,GAAA,kBACAmD,IAAA1B,OAAA1B,EAAA,UAAA+B,KAAAtB,OAAAiD,QAAAzD,GAAA,gBACAD,EAAA,IAAA2B,IAAAa,SAAA,WAAAd,OAAA0B,OAGApD,EAAA,cAAA2D,QAAA3D,EAAA,SAAA+B,KAAAe,KAAAK,UACAjC,eAAAe,OACAjC,EAAA,mBAAA+B,KAAA9B,GAAA,UACAG,WAAA4C,QAAAF,KAAAK,SAEAD,MAAA,WACAjC,iBAAAE,SAAA,sBAAAoB,OACArB,eAAAe,oBAtEA7B,YAAA8C,MAAAjD,GAAA,4CAVAG,YAAA8C,MAAAjD,GAAA","file":"routes.js","sourcesContent":["/**\n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; under version 2\n * of the License (non-upgradable).\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n *\n * Copyright (c) 2014 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);\n * \n * \n */\n\n//@see http://forge.taotesting.com/projects/tao/wiki/Front_js\ndefine('taoResultServer/controller/routes',[],function(){\n    'use strict';\n\n    return {\n        'ResultServerMgt': {\n           // 'deps' : 'controller/migrate'\n            'actions': {\n                'migrate' : 'controller/migrate'\n            }\n            \n        }\n    };\n});\n\n","/**\r\n * This program is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU General Public License\r\n * as published by the Free Software Foundation; under version 2\r\n * of the License (non-upgradable).\r\n *\r\n * This program is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU General Public License\r\n * along with this program; if not, write to the Free Software\r\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\r\n *\r\n * Copyright (c) 2013 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);\r\n *\r\n *\r\n */\r\n\r\ndefine('taoResultServer/controller/migrate',['module', 'jquery','i18n', 'context', 'helpers', 'ui/feedback'], \r\n        function(module, $, __, context, helpers, feedback){\r\n    \r\n        var migrateRunner = {\r\n            start : function(options){\r\n               $('.opButton').click(\r\n                       \r\n                            function(e) {\r\n\r\n                                var operation = $(this).attr(\"id\"),\r\n                                    sources = [],\r\n                                    targets = [],\r\n                                    $source = $(\"#selSource\"),\r\n                                    $target = $(\"#selTarget\"),\r\n                                    $migrationDialog = $(\"#migrationProgress\"),\r\n                                    $migrationInfo = $migrationDialog.children(\".migrationInfo\"),\r\n                                    source;\r\n\r\n                                //todo move\r\n                                var migrateDataUrl = context.root_url+'taoResultServer/ResultServerMgt/migrateData';\r\n\r\n                                //clean any former feedback built in the dom\r\n                                $source.empty();\r\n                                $target.empty();\r\n\r\n                                $('#sourceStorage :checked').each(function() {\r\n                                    source = $(this).val();\r\n                                    sources.push(source);\r\n\r\n                                    $source\r\n                                        .append($(\"<li />\", {id: source.replace(/[^a-z0-9-_]+/ig, \"_\")})\r\n                                        .html($(this).parent().text()));\r\n                                });\r\n                                if (!sources.length) {\r\n                                  feedback().error(__('Please select a migration source'));\r\n                                  return;\r\n                                }\r\n\r\n                                $(\"#targetStorage :checked\").each(function() {\r\n                                    targets.push($(this).val());\r\n\r\n                                    $target.append($(\"<li />\").text($(this).parent().text()));\r\n                                });\r\n                                if (!targets.length) {\r\n                                  feedback().error(__(\"Please select a destination target\"));\r\n                                  return;\r\n                                }\r\n\r\n                                $(\"#selOperation\").html(\"<label>\"+operation+\"</label>\");\r\n\r\n                                $migrationInfo.children().show();\r\n\r\n                                $migrationDialog\r\n                                    .attr(\"style\", \"visibility: visible\")\r\n                                    .dialog({\r\n                                        modal: true,\r\n                                        width: 500,\r\n                                        height: 430,\r\n                                        buttons: [\r\n                                                {\r\n                                                        id: \"MigrationClose\",\r\n                                                        text: __('Cancel'),\r\n                                                        \r\n                                                        click: function() {\r\n                                                                $(this).dialog('close');\r\n                                                        }\r\n                                                },\r\n                                                {\r\n                                                        id: \"MigrationStart\",\r\n                                                        text: __('Migrate'),\r\n                                                        click: function() {\r\n                                                            $migrationInfo.hide();\r\n                                                            $migrationDialog.children(\".migrationResult\").hide();\r\n                                                            $migrationDialog.children(\".migrationProgress\").show();\r\n                                                            $(\"#MigrationStart\").addClass(\"disabled\").off(\"click\");\r\n\r\n                                                            $.ajax({\r\n                                                              url: migrateDataUrl,\r\n                                                              type: \"POST\",\r\n                                                              dataType: \"JSON\",\r\n                                                              data: {   \r\n                                                                   source: sources,\r\n                                                                   target: targets,\r\n                                                                   operation: operation\r\n                                                              },\r\n                                                              success: function(data){\r\n\r\n                                                                  $migrationDialog.children(\".migrationProgress\").hide();\r\n\r\n                                                                  if (!data.success) {\r\n                                                                      info.show();\r\n                                                                      feedback().error(data.status);\r\n                                                                      return;\r\n                                                                  }\r\n\r\n                                                                  $migrationInfo.children(\":not(#selSource)\").hide();\r\n\r\n                                                                  var $ul = $(\"<ul/>\", {class: \"StorageResult\"}),\r\n                                                                      id;\r\n                                                                  $.each(data.data, function(i, source){\r\n                                                                      id = source.uri.replace(/[^a-z0-9-_]+/ig, \"_\");\r\n                                                                      $ul.append($('<li />', {text: source.testTakers + __(\" test takers\")}));\r\n                                                                      $ul.append($('<li />', {text: source.deliveries + __(\" deliveries\")}));\r\n                                                                      $ul.append($('<li />', {text: source.callIds + __(\" call ids\")}));\r\n                                                                      $(\"#\" + id).addClass(\"success\").append($ul);\r\n                                                                  });\r\n\r\n                                                                  $(\"#selSource\").prepend($(\"<h3/>\", {text: data.status}));\r\n                                                                  $migrationInfo.show();\r\n                                                                  $(\"#MigrationClose\").text(__(\"Close\"));\r\n                                                                  feedback().success(data.status);\r\n                                                              },\r\n                                                              error : function(){\r\n                                                                  $migrationDialog.children(\".migrationProgress\").hide();\r\n                                                                  $migrationInfo.show();\r\n                                                              }\r\n                                                            });\r\n                                                            \r\n                                                            \r\n                                                        }\r\n                                                }\r\n                                        ],\r\n\r\n                                });\r\n                            }\r\n               );\r\n\r\n         }\r\n       };\r\n   \r\n        return migrateRunner;\r\n});\n"]}